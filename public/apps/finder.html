<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finder</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel: rgba(255,255,255,0.03);
      --muted: #9aa8b2;
      --accent: #60a5fa;
      --glass: rgba(255,255,255,0.02);
      color-scheme: dark;
    }
    html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial; background: linear-gradient(180deg,#071019,#0b0f14); color:#e6eef8}
    .finder{width:100%;height:100%;display:flex;align-items:stretch;gap:18px;padding:18px}
    .window{flex:1;display:flex;flex-direction:column;background:var(--panel);border:1px solid rgba(255,255,255,0.04);border-radius:10px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    .titlebar{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .controls{display:flex;gap:8px}
    .dot{width:12px;height:12px;border-radius:50%}
    .dot.close{background:#ff5f56}
    .dot.min{background:#ffbd2e}
    .dot.max{background:#27c93f}

    .toolbar{display:flex;align-items:center;justify-content:space-between;padding:8px 6px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
    .toolbar .left{display:flex;align-items:center;gap:10px}
    .toolbar button{background:transparent;border:0;color:var(--muted);padding:6px 8px;border-radius:6px;cursor:pointer}
    .toolbar button:hover{background:rgba(255,255,255,0.02);color:var(--accent)}
    .address{padding:6px 10px;border-radius:6px;background:rgba(255,255,255,0.01);color:var(--muted);font-size:13px}

    .body{display:flex;flex:1;gap:12px;align-items:stretch;margin-top:12px}
    .sidebar{width:220px;background:transparent;border-right:1px solid rgba(255,255,255,0.02);padding:8px;display:flex;flex-direction:column;gap:8px}
    .fav{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer;color:var(--muted)}
    .fav:hover{background:rgba(255,255,255,0.01);color:var(--text)}

    .content{flex:1;display:flex;flex-direction:column}
    .grid{display:grid;grid-template-columns: repeat(auto-fill, minmax(160px,1fr));gap:12px;padding:8px;align-content:start}
    .item{padding:12px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px;cursor:pointer}
    .item:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,0.5)}
    .iconWrap{height:72px;display:flex;align-items:center;justify-content:center}
    .fname{font-weight:600;color:var(--text);font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{font-size:12px;color:var(--muted)}

    .previewModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,6,23,0.6),rgba(2,6,23,0.8));z-index:999}
    .previewCard{width:80%;max-width:1100px;height:80%;background:var(--panel);border-radius:12px;padding:16px;display:flex;flex-direction:column}
    .previewHeader{display:flex;align-items:center;justify-content:space-between}
    .previewBody{flex:1;overflow:auto;padding-top:12px}

    .empty{padding:40px;text-align:center;color:var(--muted)}

    .hint{font-size:13px;color:var(--muted)}

  </style>
</head>
<body>
  <div class="finder">
    <div class="window">
      <div class="titlebar">
        <div style="flex:1"></div>
        <div class="address" id="cwdLabel">No folder selected</div>
        <div style="flex:1"></div>
      </div>

      <div class="toolbar">
        <div class="left">
          <button id="openBtn">Open Folder</button>
          <button id="upBtn" title="Up">â–² Up</button>
          <div class="hint" id="count"></div>
        </div>
        <div class="right">
          <input id="search" placeholder="Search" style="padding:6px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.02);color:var(--text)" />
        </div>
      </div>

      <div class="body">
        <aside class="sidebar">
          <div class="fav" id="favHome">Home</div>
          <div class="fav" id="favDesktop">Desktop</div>
          <div class="fav" id="favDownloads">Downloads</div>
          <div style="flex:1"></div>
          <div class="fav" id="remember">Remember folder</div>
        </aside>

        <section class="content">
          <div id="filesArea">
            <div class="empty" id="empty">Pick a folder to show its files</div>
            <div class="grid" id="grid" style="display:none"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div class="previewModal" id="preview">
    <div class="previewCard">
      <div class="previewHeader"><div id="pTitle"></div><div><button id="closePreview">Close</button></div></div>
      <div class="previewBody" id="pBody"></div>
    </div>
  </div>

  <script>
    const openBtn = document.getElementById('openBtn');
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const cwdLabel = document.getElementById('cwdLabel');
    const count = document.getElementById('count');
    const preview = document.getElementById('preview');
    const pBody = document.getElementById('pBody');
    const pTitle = document.getElementById('pTitle');
    const closePreview = document.getElementById('closePreview');
    const search = document.getElementById('search');

  let currentHandle = null;
  let entries = [];
  let dirStack = []; // maintain navigation stack of directory handles

    function supportsFS() { return 'showDirectoryPicker' in window; }

    function formatBytes(n){ if(!n) return ''; const units=['B','KB','MB','GB']; let i=0; while(n>=1024 && i<units.length-1){ n/=1024; i++; } return n.toFixed(i?1:0)+' '+units[i]; }

    async function readDirectory(dirHandle){
      const list = [];
      for await (const [name, handle] of dirHandle.entries()){
        list.push({name, handle, kind: handle.kind});
      }
      // sort folders first
      list.sort((a,b)=>{ if(a.kind!==b.kind) return a.kind==='directory'?-1:1; return a.name.localeCompare(b.name); });
      return list;
    }

    function renderList(items){
      grid.innerHTML='';
      if(!items.length){ empty.style.display='block'; grid.style.display='none'; count.textContent='0 items'; return; }
      empty.style.display='none'; grid.style.display='grid';
      items.forEach(it=>{
        const el = document.createElement('div'); el.className='item';
        const iconWrap = document.createElement('div'); iconWrap.className='iconWrap';
        const ico = document.createElement('img'); ico.style.width='48px'; ico.style.height='48px';
        if(it.kind==='directory') ico.src='../icons/files.png'; else {
          const ext = it.name.split('.').pop().toLowerCase();
          if(['png','jpg','jpeg','gif','webp','bmp'].includes(ext)) ico.src='../icons/files.png';
          else if(['html','js','css','json','txt','md'].includes(ext)) ico.src='../icons/gchrome.png';
          else ico.src='../icons/gen.png';
        }
        iconWrap.appendChild(ico);
        const fname = document.createElement('div'); fname.className='fname'; fname.textContent=it.name;
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = it.kind;
        el.appendChild(iconWrap); el.appendChild(fname); el.appendChild(meta);
        el.addEventListener('dblclick', ()=> openEntry(it));
        grid.appendChild(el);
      });
      count.textContent = items.length + ' items';
    }

    async function openEntry(it){
      if(it.kind==='directory'){
        try{
          // push into stack and navigate
          dirStack.push(it.handle);
          currentHandle = it.handle;
          const list = await readDirectory(it.handle);
          entries = list;
          updateCwdLabel();
          renderList(list);
        }catch(e){ alert('Unable to open folder: '+e.message); }
        return;
      }
      // file preview
      try{
        const file = await it.handle.getFile();
        pTitle.textContent = it.name;
        const ext = it.name.split('.').pop().toLowerCase();
        if(file.type.startsWith('image/') || ['png','jpg','jpeg','gif','webp','bmp'].includes(ext)){
          const url = URL.createObjectURL(file);
          pBody.innerHTML = `<img src="${url}" style="max-width:100%;height:auto;border-radius:8px" />`;
        } else if(file.type.startsWith('text/') || ['txt','md','json','js','css','html'].includes(ext)){
          const text = await file.text();
          pBody.innerHTML = `<pre style="white-space:pre-wrap;word-break:break-word;color:var(--text);">${escapeHtml(text)}</pre>`;
        } else {
          pBody.innerHTML = `<div style="color:var(--muted)">No preview available for this file type.<br>Size: ${formatBytes(file.size)}</div>`;
        }
        preview.style.display='flex';
      }catch(e){ alert('Unable to preview file: '+e.message); }
    }

    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    openBtn.addEventListener('click', async ()=>{
      if(!supportsFS()){ alert('File System Access API is not available in this browser. Use Chrome or Edge.'); return; }
      try{
        const dirHandle = await window.showDirectoryPicker();
        dirStack = [dirHandle];
        currentHandle = dirHandle;
        const list = await readDirectory(dirHandle);
        entries = list;
        updateCwdLabel();
        renderList(list);
      }catch(e){ console.warn(e); }
    });

    // Up button
    document.getElementById('upBtn').addEventListener('click', async ()=>{
      if(dirStack.length<=1) return;
      dirStack.pop();
      const parent = dirStack[dirStack.length-1];
      currentHandle = parent;
      const list = await readDirectory(parent);
      entries = list;
      updateCwdLabel();
      renderList(list);
    });

    // favorites (try to use startIn when showing picker)
    document.getElementById('favHome').addEventListener('click', async ()=> openFavorite('documents'));
    document.getElementById('favDesktop').addEventListener('click', async ()=> openFavorite('desktop'));
    document.getElementById('favDownloads').addEventListener('click', async ()=> openFavorite('downloads'));

    async function openFavorite(startIn){
      if(!supportsFS()){ alert('File System Access API not available.'); return; }
      try{
        // some browsers accept {startIn: 'desktop'|'documents'|'downloads'}
        const dirHandle = await window.showDirectoryPicker({ startIn });
        if(dirHandle){ dirStack = [dirHandle]; currentHandle = dirHandle; const list = await readDirectory(dirHandle); entries=list; updateCwdLabel(); renderList(list); }
      }catch(e){ console.warn(e); }
    }

    function updateCwdLabel(){
      try{
        const names = dirStack.map(h=>h.name).filter(Boolean);
        cwdLabel.textContent = names.length? names.join(' / ') : (dirStack[0] && dirStack[0].name) || 'Selected folder';
      }catch(e){ cwdLabel.textContent = 'Selected folder'; }
      // update up button state
      document.getElementById('upBtn').disabled = dirStack.length<=1;
    }

    closePreview.addEventListener('click', ()=>{ preview.style.display='none'; pBody.innerHTML=''; pTitle.textContent=''; });

    search.addEventListener('input', ()=>{
      const q = search.value.trim().toLowerCase();
      const filtered = entries.filter(e=> e.name.toLowerCase().includes(q));
      renderList(filtered);
    });

    // simple favorites: try to use persisted handles
    (async function tryRestore(){
      try{
        const key = 'elura_finder_handle';
        const stored = localStorage.getItem(key);
        if(stored){
          // can't rehydrate handles cross-origin without showDirectoryPicker permission, so skip
        }
      }catch(e){}
    })();

    // helper to read entries for desktop/downloads if available via window.chooseFileSystemEntries (older)

  </script>
</body>
</html>
